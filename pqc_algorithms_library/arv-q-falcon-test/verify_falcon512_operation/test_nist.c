#include <riscv_vector.h>
#include <stdint.h>
#include <stdlib.h>
#include <stdio.h>
#include <stdbool.h>
#include <time.h>
#include "inner.h"
#include "params_custom.h"
#include "api.h"
#include "../apis/custom_inst_api.h"

void get_pk_and_sk()
{
	uint8_t sk[CRYPTO_SECRETKEYBYTES];
	uint8_t pk[CRYPTO_PUBLICKEYBYTES];
    int i;

	int r = crypto_sign_keypair_custom(pk, sk);

    printf("pk:\n");
    for(i = 0; i < CRYPTO_PUBLICKEYBYTES; i++) {
        printf("%d, ", pk[i]);
        if((i+1) % 32 == 0) {
            printf("\n");
        }
    }
    printf("\n\n");

    printf("sk:\n");
    for(i = 0; i < CRYPTO_SECRETKEYBYTES; i++) {
        printf("%d, ", sk[i]);
        if((i+1) % 32 == 0) {
            printf("\n");
        }
    }
}

const uint8_t pk[] = {
9, 48, 40, 89, 139, 183, 253, 76, 104, 220, 61, 231, 190, 248, 42, 16, 209, 64, 123, 60, 109, 60, 3, 216, 88, 84, 140, 112, 95, 41, 157, 49, 
102, 75, 108, 165, 81, 212, 168, 66, 23, 78, 171, 66, 138, 56, 117, 131, 206, 30, 115, 171, 139, 181, 135, 113, 10, 223, 152, 213, 180, 234, 74, 172, 
41, 222, 54, 9, 67, 38, 106, 243, 90, 247, 214, 146, 30, 145, 246, 238, 55, 65, 33, 21, 40, 245, 148, 193, 200, 142, 202, 167, 203, 105, 210, 151, 
218, 62, 183, 246, 18, 165, 103, 66, 245, 108, 119, 23, 168, 81, 27, 188, 23, 106, 162, 204, 69, 218, 112, 14, 125, 152, 110, 1, 116, 221, 115, 53, 
236, 132, 198, 49, 42, 120, 152, 14, 123, 104, 101, 22, 6, 111, 39, 16, 211, 95, 122, 57, 100, 160, 24, 214, 236, 50, 147, 49, 45, 60, 38, 135, 
64, 174, 90, 172, 100, 98, 79, 124, 62, 41, 217, 44, 165, 250, 1, 127, 12, 148, 65, 133, 102, 105, 39, 104, 134, 54, 226, 66, 112, 157, 137, 213, 
14, 101, 74, 233, 49, 27, 46, 21, 240, 43, 252, 177, 68, 14, 90, 193, 64, 145, 139, 61, 206, 166, 49, 123, 193, 138, 253, 17, 155, 229, 54, 181, 
166, 234, 36, 239, 212, 26, 253, 82, 113, 43, 86, 123, 23, 46, 113, 199, 26, 126, 194, 51, 116, 7, 131, 205, 9, 235, 51, 1, 23, 209, 80, 56, 
200, 16, 121, 107, 22, 44, 178, 8, 133, 36, 95, 177, 6, 239, 135, 89, 37, 51, 254, 166, 231, 240, 234, 134, 176, 57, 130, 41, 246, 43, 42, 61, 
12, 224, 205, 86, 134, 238, 134, 230, 103, 10, 51, 92, 22, 86, 232, 152, 142, 98, 224, 228, 59, 63, 200, 127, 49, 214, 128, 89, 19, 192, 33, 8, 
251, 90, 49, 7, 234, 169, 186, 191, 68, 4, 134, 168, 218, 192, 130, 38, 71, 244, 17, 223, 193, 151, 173, 40, 51, 229, 100, 251, 234, 152, 164, 87, 
128, 97, 240, 243, 17, 4, 48, 90, 215, 192, 142, 21, 67, 13, 73, 33, 72, 0, 98, 14, 198, 197, 52, 135, 219, 97, 189, 75, 196, 166, 132, 78, 
102, 109, 6, 100, 24, 57, 231, 68, 129, 133, 44, 200, 51, 169, 133, 111, 211, 77, 116, 169, 138, 152, 148, 145, 142, 102, 101, 4, 153, 36, 51, 78, 
216, 168, 50, 133, 182, 218, 66, 176, 114, 153, 186, 136, 78, 12, 135, 35, 231, 18, 92, 62, 70, 158, 179, 5, 56, 135, 149, 84, 135, 230, 225, 200, 
146, 228, 19, 77, 137, 88, 50, 55, 191, 169, 207, 183, 105, 236, 123, 19, 80, 201, 197, 38, 126, 12, 93, 12, 98, 37, 44, 224, 138, 115, 78, 235, 
146, 151, 174, 126, 130, 224, 111, 178, 13, 28, 16, 165, 81, 4, 131, 28, 152, 70, 130, 28, 62, 147, 255, 40, 179, 50, 17, 65, 196, 137, 68, 13, 
11, 45, 46, 58, 104, 188, 71, 108, 99, 201, 249, 181, 42, 53, 126, 168, 110, 135, 49, 4, 58, 47, 71, 147, 150, 203, 237, 147, 26, 192, 5, 52, 
110, 152, 173, 138, 41, 11, 133, 242, 133, 26, 60, 161, 133, 208, 184, 77, 164, 154, 224, 196, 42, 198, 168, 127, 108, 46, 24, 80, 39, 58, 150, 205, 
80, 182, 160, 102, 56, 162, 236, 108, 111, 147, 97, 213, 191, 237, 76, 245, 105, 175, 166, 163, 213, 210, 8, 82, 135, 182, 14, 250, 210, 198, 104, 91, 
62, 189, 95, 174, 192, 192, 231, 18, 8, 64, 11, 14, 179, 155, 129, 87, 154, 5, 234, 48, 228, 69, 130, 156, 228, 7, 216, 75, 54, 188, 222, 84, 
251, 162, 113, 40, 147, 0, 141, 125, 131, 125, 106, 165, 165, 29, 108, 67, 61, 118, 74, 53, 211, 130, 106, 77, 90, 141, 207, 76, 143, 242, 156, 42, 
54, 54, 218, 62, 193, 169, 94, 64, 190, 45, 229, 100, 48, 121, 7, 125, 159, 227, 58, 209, 189, 65, 5, 69, 236, 242, 81, 136, 79, 34, 2, 240, 
118, 148, 52, 165, 105, 175, 90, 227, 94, 49, 80, 52, 208, 111, 101, 28, 120, 133, 49, 9, 136, 97, 61, 105, 82, 198, 105, 166, 59, 110, 74, 83, 
223, 105, 200, 231, 225, 36, 35, 242, 175, 252, 185, 57, 214, 177, 36, 152, 164, 135, 30, 214, 135, 124, 18, 24, 178, 75, 112, 175, 251, 24, 138, 251, 
75, 108, 119, 215, 200, 203, 144, 68, 52, 43, 57, 66, 144, 89, 239, 246, 158, 31, 227, 11, 136, 254, 224, 77, 95, 68, 248, 216, 247, 2, 187, 27, 
152, 191, 154, 196, 232, 44, 248, 40, 10, 246, 32, 188, 44, 90, 209, 143, 228, 62, 201, 47, 84, 23, 219, 119, 32, 54, 104, 109, 24, 4, 163, 147, 
186, 78, 37, 4, 58, 167, 23, 61, 179, 222, 143, 138, 23, 111, 109, 72, 215, 164, 152, 64, 229, 38, 72, 176, 73, 151, 201, 101, 205, 99, 66, 66, 
94, 162, 187, 165, 17, 213, 211, 46, 211, 250, 34, 12, 175, 162, 138, 68, 188, 33, 101, 114, 42, 96, 133, 191, 134, 148, 147, 86, 180, 163, 249, 33, 
164
};

const uint8_t sk[] = {
89, 58, 241, 239, 61, 32, 16, 129, 16, 0, 59, 31, 12, 254, 176, 255, 129, 110, 20, 196, 111, 16, 123, 47, 20, 67, 241, 31, 68, 79, 4, 197, 
239, 11, 250, 255, 3, 255, 207, 7, 252, 242, 19, 60, 177, 231, 127, 1, 20, 66, 97, 20, 194, 241, 3, 126, 65, 8, 70, 192, 251, 253, 30, 248, 
62, 47, 4, 68, 63, 8, 128, 240, 223, 68, 96, 240, 124, 207, 235, 60, 49, 4, 255, 62, 16, 1, 209, 231, 65, 14, 248, 67, 240, 227, 61, 0, 
212, 196, 15, 16, 63, 65, 8, 194, 254, 19, 186, 46, 12, 130, 241, 243, 195, 0, 0, 61, 35, 4, 255, 46, 28, 254, 0, 216, 129, 81, 28, 121, 
17, 16, 129, 95, 252, 125, 16, 240, 126, 49, 20, 2, 31, 240, 2, 161, 19, 2, 224, 15, 128, 175, 251, 70, 1, 4, 130, 32, 8, 190, 192, 252, 
191, 17, 240, 3, 240, 239, 1, 49, 232, 61, 49, 232, 191, 208, 39, 125, 31, 244, 197, 63, 12, 252, 49, 240, 253, 31, 4, 1, 194, 51, 66, 64, 
28, 130, 97, 252, 62, 223, 3, 185, 0, 224, 197, 177, 3, 191, 241, 23, 68, 94, 8, 130, 15, 8, 255, 159, 31, 202, 96, 252, 66, 65, 0, 72, 
224, 247, 255, 32, 12, 126, 0, 32, 130, 240, 251, 68, 224, 247, 190, 239, 15, 0, 32, 252, 6, 177, 7, 64, 225, 15, 193, 207, 243, 2, 208, 11, 
4, 143, 12, 191, 63, 12, 63, 224, 27, 132, 112, 244, 0, 16, 12, 0, 16, 20, 57, 208, 23, 70, 224, 11, 59, 97, 19, 201, 33, 16, 127, 176, 
255, 127, 15, 8, 188, 207, 247, 122, 223, 235, 1, 32, 16, 5, 80, 24, 140, 222, 3, 64, 255, 15, 130, 241, 31, 5, 31, 244, 130, 239, 251, 0, 
240, 3, 63, 111, 8, 249, 15, 252, 129, 0, 12, 132, 255, 23, 134, 96, 248, 60, 176, 212, 194, 126, 236, 67, 159, 248, 198, 80, 12, 254, 240, 235, 
195, 15, 4, 197, 17, 0, 195, 241, 11, 63, 33, 232, 66, 191, 247, 196, 125, 11, 255, 177, 11, 6, 33, 232, 125, 255, 31, 126, 33, 0, 7, 97, 
252, 188, 32, 8, 5, 207, 219, 63, 96, 244, 196, 46, 8, 5, 223, 15, 1, 0, 0, 188, 112, 19, 4, 2, 252, 67, 207, 239, 251, 32, 0, 2, 
177, 239, 126, 112, 248, 135, 143, 3, 187, 127, 236, 193, 144, 19, 197, 15, 8, 193, 111, 4, 128, 158, 252, 3, 33, 252, 68, 16, 248, 192, 222, 7, 
197, 95, 252, 194, 1, 240, 2, 193, 243, 66, 63, 228, 255, 64, 16, 189, 47, 232, 124, 239, 231, 70, 143, 251, 1, 208, 39, 71, 207, 247, 189, 47, 
12, 5, 174, 32, 65, 223, 15, 69, 209, 251, 66, 63, 248, 253, 191, 247, 255, 189, 23, 60, 224, 7, 56, 223, 239, 191, 47, 236, 0, 17, 252, 251, 
0, 16, 68, 192, 247, 129, 225, 15, 65, 94, 0, 59, 15, 0, 186, 191, 7, 63, 80, 224, 127, 159, 15, 57, 32, 12, 56, 225, 39, 124, 32, 20, 
254, 241, 3, 63, 82, 248, 60, 127, 11, 131, 61, 8, 64, 177, 3, 122, 14, 12, 130, 255, 31, 126, 63, 252, 70, 14, 8, 1, 0, 28, 127, 49, 
244, 0, 33, 248, 187, 63, 12, 133, 222, 19, 130, 47, 236, 0, 30, 20, 190, 254, 11, 127, 192, 15, 191, 192, 15, 61, 221, 251, 129, 174, 251, 4, 
31, 0, 66, 1, 252, 66, 223, 35, 124, 63, 248, 187, 127, 19, 6, 191, 15, 121, 175, 243, 191, 30, 244, 254, 80, 0, 195, 239, 7, 255, 33, 244, 
193, 111, 236, 189, 16, 244, 250, 160, 12, 7, 0, 16, 255, 175, 7, 132, 79, 248, 186, 127, 244, 123, 240, 11, 125, 30, 12, 1, 14, 0, 128, 209, 
47, 0, 208, 15, 0, 31, 4, 63, 162, 252, 123, 48, 4, 67, 112, 16, 129, 48, 20, 7, 223, 247, 117, 191, 255, 251, 207, 251, 193, 128, 248, 126, 
16, 20, 3, 176, 27, 255, 239, 23, 184, 15, 252, 195, 30, 12, 190, 47, 20, 65, 193, 35, 191, 48, 248, 3, 17, 12, 194, 0, 224, 192, 255, 35, 
131, 64, 20, 254, 112, 3, 64, 32, 0, 197, 80, 255, 185, 239, 19, 69, 47, 252, 130, 49, 244, 123, 159, 12, 129, 0, 24, 65, 32, 4, 130, 80, 
16, 230, 238, 230, 236, 233, 207, 24, 15, 19, 41, 14, 44, 19, 234, 31, 54, 235, 224, 17, 0, 39, 210, 3, 247, 22, 248, 245, 2, 36, 12, 10, 
5, 12, 33, 37, 255, 245, 198, 211, 230, 224, 0, 48, 237, 235, 251, 26, 233, 238, 252, 12, 211, 231, 237, 36, 18, 249, 13, 29, 0, 236, 19, 11, 
38, 226, 233, 51, 35, 5, 0, 241, 28, 229, 249, 6, 20, 8, 25, 250, 215, 9, 24, 231, 223, 1, 242, 9, 13, 9, 249, 14, 255, 29, 249, 253, 
1, 255, 241, 232, 59, 230, 34, 51, 231, 18, 13, 17, 57, 254, 237, 230, 20, 225, 16, 236, 242, 239, 219, 252, 245, 25, 23, 254, 251, 215, 253, 3, 
8, 232, 24, 203, 27, 10, 36, 251, 235, 1, 255, 0, 229, 254, 0, 229, 7, 219, 14, 3, 239, 22, 232, 239, 240, 250, 27, 21, 245, 246, 217, 248, 
220, 14, 2, 4, 239, 237, 7, 2, 13, 253, 7, 18, 221, 20, 243, 222, 54, 6, 12, 1, 46, 14, 233, 13, 218, 59, 254, 213, 26, 254, 246, 250, 
232, 15, 75, 32, 247, 49, 27, 28, 245, 254, 8, 195, 255, 226, 34, 209, 192, 19, 244, 249, 248, 247, 232, 21, 247, 5, 247, 12, 19, 1, 250, 233, 
31, 244, 7, 10, 178, 10, 19, 13, 53, 250, 8, 200, 10, 237, 238, 221, 243, 226, 6, 32, 31, 26, 12, 248, 0, 5, 13, 42, 33, 241, 29, 231, 
195, 8, 0, 31, 232, 216, 8, 11, 31, 231, 6, 4, 212, 244, 228, 235, 234, 246, 230, 12, 235, 28, 54, 10, 238, 18, 8, 26, 14, 9, 8, 39, 
229, 254, 243, 16, 255, 241, 17, 214, 250, 11, 31, 26, 250, 254, 246, 245, 232, 248, 15, 253, 247, 1, 252, 253, 22, 239, 32, 39, 251, 26, 221, 39, 
1, 13, 1, 60, 235, 6, 247, 12, 31, 248, 19, 34, 210, 1, 195, 43, 50, 0, 22, 3, 236, 18, 247, 47, 252, 224, 243, 246, 231, 244, 242, 2, 
253, 6, 209, 27, 27, 204, 68, 237, 17, 250, 22, 23, 241, 0, 20, 29, 250, 0, 54, 30, 5, 226, 14, 17, 237, 218, 245, 28, 243, 2, 37, 21, 
242, 238, 19, 232, 36, 236, 191, 228, 213, 240, 225, 251, 25, 243, 3, 211, 58, 24, 2, 45, 13, 7, 248, 203, 6, 4, 30, 239, 240, 17, 36, 253, 
7, 254, 253, 24, 36, 212, 227, 233, 222, 230, 255, 218, 226, 246, 7, 19, 228, 23, 45, 42, 250, 218, 254, 1, 246, 245, 222, 246, 207, 235, 247, 17, 
28, 27, 38, 16, 203, 19, 68, 242, 15, 46, 7, 2, 215, 12, 27, 16, 239, 24, 50, 20, 44, 22, 254, 242, 55, 225, 218, 218, 43, 3, 10, 247, 
1, 37, 16, 249, 232, 39, 242, 2, 1, 214, 15, 215, 32, 254, 241, 237, 18, 2, 232, 235, 23, 30, 24, 232, 249, 6, 8, 3, 251, 32, 6, 8, 
246  
};

#define KAT_SUCCESS          0
#define KAT_CRYPTO_FAILURE  -1
#define MLEN 32

bool test_crypto_sign_no_rvvf_and_open_custom()
{
    unsigned char       sm[CRYPTO_BYTES+MLEN];
    unsigned char       m1[MLEN];
    unsigned long long  smlen, mlen1;
    unsigned long long  mlen = MLEN;
    int                 ret_val;
    unsigned char       msg[MLEN];

    generate_inorder_uint8(msg, MLEN, NOT_NEED_BOUND);

    if ( (ret_val = crypto_sign_custom_no_rvvf(sm, &smlen, msg, mlen, sk)) != 0) {
        printf("crypto_sign returned <%d>\n", ret_val);
        return KAT_CRYPTO_FAILURE;
    }    

    if ( (ret_val = crypto_sign_open_custom(m1, &mlen1, sm, smlen, pk)) != 0) {
        printf("crypto_sign_open returned <%d>\n", ret_val);
        return KAT_CRYPTO_FAILURE;
    }

    bool result = check_same_uint8(msg, m1, MLEN);

    if(result) {
        printf("test_crypto_sign_no_rvvf_and_open_custom pass with result=%d!\n", result);
    }
    else {
        printf("test_crypto_sign_no_rvvf_and_open_custom fail with result=%d!\n", result);
    }

    return result;
}

bool test_crypto_sign_with_rvvf_and_open_custom()
{
    unsigned char       sm[CRYPTO_BYTES+MLEN];
    unsigned char       m1[MLEN];
    unsigned long long  smlen, mlen1;
    unsigned long long  mlen = MLEN;
    int                 ret_val;
    unsigned char       msg[MLEN];

    generate_inorder_uint8(msg, MLEN, NOT_NEED_BOUND);

    if ( (ret_val = crypto_sign_custom_with_rvvf(sm, &smlen, msg, mlen, sk)) != 0) {
        printf("crypto_sign returned <%d>\n", ret_val);
        return KAT_CRYPTO_FAILURE;
    }    

    if ( (ret_val = crypto_sign_open_custom(m1, &mlen1, sm, smlen, pk)) != 0) {
        printf("crypto_sign_open returned <%d>\n", ret_val);
        return KAT_CRYPTO_FAILURE;
    }

    bool result = check_same_uint8(msg, m1, MLEN);

    if(result) {
        printf("test_crypto_sign_with_rvvf_and_open_custom pass with result=%d!\n", result);
    }
    else {
        printf("test_crypto_sign_with_rvvf_and_open_custom fail with result=%d!\n", result);
    }

    return result;
}


bool test_crypto_sign_no_cus_spz_and_open_custom()
{
    unsigned char       sm[CRYPTO_BYTES+MLEN];
    unsigned char       m1[MLEN];
    unsigned long long  smlen, mlen1;
    unsigned long long  mlen = MLEN;
    int                 ret_val;
    unsigned char       msg[MLEN];

    generate_inorder_uint8(msg, MLEN, NOT_NEED_BOUND);

    if ( (ret_val = crypto_sign_custom_no_cus_spz(sm, &smlen, msg, mlen, sk)) != 0) {
        printf("crypto_sign returned <%d>\n", ret_val);
        return KAT_CRYPTO_FAILURE;
    }    

    if ( (ret_val = crypto_sign_open_custom(m1, &mlen1, sm, smlen, pk)) != 0) {
        printf("crypto_sign_open returned <%d>\n", ret_val);
        return KAT_CRYPTO_FAILURE;
    }

    bool result = check_same_uint8(msg, m1, MLEN);

    if(result) {
        printf("test_crypto_sign_no_cus_spz_and_open_custom pass with result=%d!\n", result);
    }
    else {
        printf("test_crypto_sign_no_cus_spz_and_open_custom fail with result=%d!\n", result);
    }

    return result;
}


int main()
{
    // get_pk_and_sk();
    // test_crypto_sign_no_rvvf_and_open_custom();
    test_crypto_sign_with_rvvf_and_open_custom();
    test_crypto_sign_no_cus_spz_and_open_custom();
    return 0;
}