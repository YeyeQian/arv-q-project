#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdbool.h>
#include <ctype.h>
#include <stdlib.h>
#include <time.h>
#include "../apis/custom_inst_api.h"
#include <riscv_vector.h>
#include "../common/debug.h"
#include "param.h"
#include "poly.h"
#include "ntt.h"
#include "reduce.h"

bool absolute_justify(int32_t a, int32_t b) {
    bool flag;

    int32_t diff = a - b;

    flag = ((diff % Q) == 0);

    return flag;
}

bool test_ntt(){
    uint64_t start, end;
    int32_t din[N]={
        2705443,4491091,7593175,6394453,7118526,5172677,524549,7512478,3542671,6272279,2545679,4309115,2388060,1984660,1674525,5018804,
        4295839,5180858,6055411,1820193,3890211,7927177,1724846,3399081,7903736,6572853,3563254,5812639,1811913,2351667,2624379,4433541,
        2143640,5825192,5445602,5315623,2202061,4848440,2955528,6343966,4214966,2870582,5664174,7003306,7923288,4259379,4860795,2536439,
        378788,2596842,6691174,2356150,4605465,2533525,5781115,2248738,4622766,276116,3365892,7217241,4821807,5384325,6889489,8272926,
        4394741,7381929,4052056,1813753,2217212,6859709,7352199,280502,7316057,7374115,3467231,1876288,856591,2978160,352072,6047205,
        1251407,216929,4266155,6680306,1433346,4028452,2575043,7912882,7272906,6782731,6361662,3475407,4992084,8040087,6332742,1301008,
        6313747,2124010,7600490,3368056,7535953,639895,799712,1546947,2405805,5647056,5906228,1843017,8277997,1587183,5817669,2016314,
        2073142,2046321,7883956,6069054,1601701,313658,809894,8138612,1850948,2110283,1955825,8034510,6736994,5884364,6811034,8132568,
        1299016,5099134,4877765,3884238,973907,6047883,3069429,6868769,1023595,5769649,2787770,2091089,5675221,6694357,2498480,985394,
        903024,7002607,6634478,7469192,5048394,1204828,1833413,4370434,4589716,7176331,1598702,6202785,7024128,1765385,2573581,4157551,
        2835309,2986490,4291226,6582183,1695244,4202203,3376165,5492008,7524299,2084794,6127362,7318882,1116721,2757059,6130763,3992457,
        7695510,6385709,3337801,6285370,2404279,3147915,1578045,5113466,7736754,4452986,913540,983058,8301908,8009394,7693855,3644499,
        6548954,454767,7038104,3343405,4984321,4517194,4632143,6643639,8306052,6597215,3733019,2171144,3775719,4632542,6080851,558968,
        1717438,1177343,3779126,7498561,5984822,3424332,5716400,1367670,385042,2316367,5001603,7051376,1221638,6451624,8138958,808317,
        652387,943986,6960111,1607181,7092027,4904989,4367058,8081193,1309131,7530130,7489172,3854927,4828768,7452105,1513608,201661,
        5366401,1699000,2496419,4449287,195724,6827682,8182333,8085524,1889200,6119102,7422011,4202372,2830143,7321425,1155993,3535723
    };
    int32_t dout[N];
    int32_t dout_ref[N];
    int32_t reversed_dout_ref[N];
    for(int i=0;i<N;i++){
        dout[i]=dout_ref[i]=din[i];
    }

    __asm__ __volatile__ ( "rdcycle %[dest]" : [dest] "=r"(start): );
    ntt(dout_ref);
    __asm__ __volatile__ ( "rdcycle %[dest]" : [dest] "=r"(end): );
    printf("ntt takes %lu cycles\n",end-start);

    for(int i=0;i<N;i++){
        reversed_dout_ref[tree[i]]=dout_ref[i];
    }
    csr_modulusq_rw(Q);
    csr_qinv_rw(QINV_HW);

    __asm__ __volatile__ ( "rdcycle %[dest]" : [dest] "=r"(start): );
    // ntt_cg_custom_reorder_asm(dout);
    ntt_cg_custom_reorder(dout);
    __asm__ __volatile__ ( "rdcycle %[dest]" : [dest] "=r"(end): );
    printf("ntt_cg_custom_reorder takes %lu cycles\n",end-start);

    bool flag = true;
    for(int i = 0; i < N; i++) {
        if(!absolute_justify(dout[i],reversed_dout_ref[i])) {
            log_e("dout_ref[%d]=%d, while dout[%d]=%d", i, dout_ref[i], i, dout[i]);
            flag = false;
        }
    }    

    if(flag) {
        printf("test_ntt test pass!\n");
    }
    else {
        printf("test_ntt test fail..\n");
    }
    printf("ntt_cg_custom_reorder takes %d cycles\n",end-start);

    return flag;
}

bool test_intt(){//for this function to work properly, you should annotate the montgomery_reduce in the end of invntt_tomont in ntt.c
    int32_t din[N]={//normal order,for invntt_cg_custom_reorder input
        2705443,4491091,7593175,6394453,7118526,5172677,524549,7512478,3542671,6272279,2545679,4309115,2388060,1984660,1674525,5018804,
        4295839,5180858,6055411,1820193,3890211,7927177,1724846,3399081,7903736,6572853,3563254,5812639,1811913,2351667,2624379,4433541,
        2143640,5825192,5445602,5315623,2202061,4848440,2955528,6343966,4214966,2870582,5664174,7003306,7923288,4259379,4860795,2536439,
        378788,2596842,6691174,2356150,4605465,2533525,5781115,2248738,4622766,276116,3365892,7217241,4821807,5384325,6889489,8272926,
        4394741,7381929,4052056,1813753,2217212,6859709,7352199,280502,7316057,7374115,3467231,1876288,856591,2978160,352072,6047205,
        1251407,216929,4266155,6680306,1433346,4028452,2575043,7912882,7272906,6782731,6361662,3475407,4992084,8040087,6332742,1301008,
        6313747,2124010,7600490,3368056,7535953,639895,799712,1546947,2405805,5647056,5906228,1843017,8277997,1587183,5817669,2016314,
        2073142,2046321,7883956,6069054,1601701,313658,809894,8138612,1850948,2110283,1955825,8034510,6736994,5884364,6811034,8132568,
        1299016,5099134,4877765,3884238,973907,6047883,3069429,6868769,1023595,5769649,2787770,2091089,5675221,6694357,2498480,985394,
        903024,7002607,6634478,7469192,5048394,1204828,1833413,4370434,4589716,7176331,1598702,6202785,7024128,1765385,2573581,4157551,
        2835309,2986490,4291226,6582183,1695244,4202203,3376165,5492008,7524299,2084794,6127362,7318882,1116721,2757059,6130763,3992457,
        7695510,6385709,3337801,6285370,2404279,3147915,1578045,5113466,7736754,4452986,913540,983058,8301908,8009394,7693855,3644499,
        6548954,454767,7038104,3343405,4984321,4517194,4632143,6643639,8306052,6597215,3733019,2171144,3775719,4632542,6080851,558968,
        1717438,1177343,3779126,7498561,5984822,3424332,5716400,1367670,385042,2316367,5001603,7051376,1221638,6451624,8138958,808317,
        652387,943986,6960111,1607181,7092027,4904989,4367058,8081193,1309131,7530130,7489172,3854927,4828768,7452105,1513608,201661,
        5366401,1699000,2496419,4449287,195724,6827682,8182333,8085524,1889200,6119102,7422011,4202372,2830143,7321425,1155993,3535723
    };
    int32_t reversed_din[N];//bit-reversed order, for invntt_tomont input
    for(int i=0;i<N;i++){
        reversed_din[tree[i]]=din[i];
    }
    int32_t dout[N];
    int32_t dout_ref[N];
    for(int i=0;i<N;i++){
        dout_ref[i]=reversed_din[i];
        dout[i]=din[i];
    }
    invntt_tomont(dout_ref);
    for(int i=0;i<N;i++){
        int64_t c=(int64_t)dout_ref[i]*8347681;
        dout_ref[i]=c%Q;
    }
    csr_modulusq_rw(Q);
    csr_qinv_rw(QINV_HW);
    // invntt_cg_custom_reorder_asm(dout);
    invntt_cg_custom_reorder(dout);
    bool flag = true;
    for(int i = 0; i < N; i++) {
        if(!absolute_justify(dout[i],dout_ref[i])) {
            log_e("dout_ref[%d]=%d, while dout[%d]=%d", i, dout_ref[i], i, dout[i]);
            flag = false;
        }
    }    

    if(flag) {
        printf("test_invntt test pass!\n");
    }
    else {
        printf("test_invntt test fail..\n");
    }

    return flag;
}

void test_chorder(){
    int32_t d[N];
    for(int i=0;i<N;i++)d[i]=i;
    chorder(d);
    printf("bit-reverse order:\n");
    for(int i=0;i<N;i++){
        printf("%d,",d[i]);
        if((i+1)%16==0)printf("\n");
    }
    chorder(d);
    printf("normal order:\n");
    for(int i=0;i<N;i++){
        printf("%d,",d[i]);
        if((i+1)%16==0)printf("\n");
    }
}

int main()
{
    //test_ntt();
    test_intt();
    return 0;
}