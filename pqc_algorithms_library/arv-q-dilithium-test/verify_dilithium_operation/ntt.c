#include <stdint.h>
#include "param.h"
#include "ntt.h"
#include "reduce.h"

static const int32_t zetas[N] = {
         0,    25847, -2608894,  -518909,   237124,  -777960,  -876248,   466468,
   1826347,  2353451,  -359251, -2091905,  3119733, -2884855,  3111497,  2680103,
   2725464,  1024112, -1079900,  3585928,  -549488, -1119584,  2619752, -2108549,
  -2118186, -3859737, -1399561, -3277672,  1757237,   -19422,  4010497,   280005,
   2706023,    95776,  3077325,  3530437, -1661693, -3592148, -2537516,  3915439,
  -3861115, -3043716,  3574422, -2867647,  3539968,  -300467,  2348700,  -539299,
  -1699267, -1643818,  3505694, -3821735,  3507263, -2140649, -1600420,  3699596,
    811944,   531354,   954230,  3881043,  3900724, -2556880,  2071892, -2797779,
  -3930395, -1528703, -3677745, -3041255, -1452451,  3475950,  2176455, -1585221,
  -1257611,  1939314, -4083598, -1000202, -3190144, -3157330, -3632928,   126922,
   3412210,  -983419,  2147896,  2715295, -2967645, -3693493,  -411027, -2477047,
   -671102, -1228525,   -22981, -1308169,  -381987,  1349076,  1852771, -1430430,
  -3343383,   264944,   508951,  3097992,    44288, -1100098,   904516,  3958618,
  -3724342,    -8578,  1653064, -3249728,  2389356,  -210977,   759969, -1316856,
    189548, -3553272,  3159746, -1851402, -2409325,  -177440,  1315589,  1341330,
   1285669, -1584928,  -812732, -1439742, -3019102, -3881060, -3628969,  3839961,
   2091667,  3407706,  2316500,  3817976, -3342478,  2244091, -2446433, -3562462,
    266997,  2434439, -1235728,  3513181, -3520352, -3759364, -1197226, -3193378,
    900702,  1859098,   909542,   819034,   495491, -1613174,   -43260,  -522500,
   -655327, -3122442,  2031748,  3207046, -3556995,  -525098,  -768622, -3595838,
    342297,   286988, -2437823,  4108315,  3437287, -3342277,  1735879,   203044,
   2842341,  2691481, -2590150,  1265009,  4055324,  1247620,  2486353,  1595974,
  -3767016,  1250494,  2635921, -3548272, -2994039,  1869119,  1903435, -1050970,
  -1333058,  1237275, -3318210, -1430225,  -451100,  1312455,  3306115, -1962642,
  -1279661,  1917081, -2546312, -1374803,  1500165,   777191,  2235880,  3406031,
   -542412, -2831860, -1671176, -1846953, -2584293, -3724270,   594136, -3776993,
  -2013608,  2432395,  2454455,  -164721,  1957272,  3369112,   185531, -1207385,
  -3183426,   162844,  1616392,  3014001,   810149,  1652634, -3694233, -1799107,
  -3038916,  3523897,  3866901,   269760,  2213111,  -975884,  1717735,   472078,
   -426683,  1723600, -1803090,  1910376, -1667432, -1104333,  -260646, -3833893,
  -2939036, -2235985,  -420899, -2286327,   183443,  -976891,  1612842, -3545687,
   -554416,  3919660,   -48306, -1362209,  3937738,  1400424,  -846154,  1976782
};

const int32_t zetas_inv_in_order[256]={
  6403635,1962642,1799107,3595838,3833893,6784443,3776993,3193378,3545687,1050970,1207385,522500,7908339,8177373,4974386,3562462,
  1362209,1430225,5366416,5173371,6470041,7115408,1846953,4867236,2286327,3548272,164721,7561383,8110657,4272102,1374803,4562441,
  6979993,7067962,6727783,525098,1104333,7132797,3724270,3759364,976891,6511298,5011305,1613174,975884,3342277,7603226,6136326,
  4460757,7143142,8217573,3122442,6656817,5688936,2831860,5945978,2235985,7129923,5948022,6521319,4856520,8093429,6463336,4972711,
  846154,5074302,3694233,768622,260646,5894064,7786281,1197226,6767575,6476982,8194886,43260,6662682,6644538,6144537,2446433,
  48306,3318210,6764025,6348669,1803090,2590150,1671176,1235728,420899,5744496,5925962,7470875,4513516,2437823,2546312,6063917,
  4442679,451100,7570268,3556995,1667432,4325093,2584293,3520352,8196974,2994039,6423145,7884926,6167306,4943130,6880252,3342478,
  554416,1333058,3183426,655327,426683,5538076,542412,8113420,2939036,3767016,2013608,7479715,3038916,8038120,1279661,6288750,

  4540456,1430430,1316856,8253495,7039087,2477047,4421799,1585221,1439742,1308169,3249728,1000202,1851402,5665122,5282425,3041255,
  3881060,7031341,210977,3157330,177440,3693493,1100098,4904467,1584928,1228525,8578,6441103,3553272,983419,8115473,1528703,
  3628969,6527646,7620448,3632928,7064828,411027,7475901,6203962,812732,22981,6727353,4083598,5220671,6232521,7871466,3677745,
  3019102,381987,5991061,3190144,2409325,2967645,8336129,1452451,7094748,671102,3724342,1257611,8190869,4968207,3343383,3930395,

  2797779,539299,4680821,4464978,4499374,2867647,3821735,4849980,2556880,300467,2140649,3592148,7849063,3043716,1643818,8284641,
  6308525,6031717,1600420,2537516,7426187,4805995,4874723,5303092,4479693,4840449,4873154,1661693,7568473,3861115,1699267,5674394,

  8100412,2108549,3277672,4794489,19422,1119584,3859737,7356305,4369920,5760665,1399561,1079900,6623180,549488,2118186,5654953,
  5700314,2091905,2884855,6026966,5268920,359251,5260684,6554070,7913949,777960,876248,8143293,518909,2608894,8354570,0
};

const uint32_t tree_byteoffset[256]={
  0,512,256,768,128,640,384,896,64,576,320,832,192,704,448,960,
  32,544,288,800,160,672,416,928,96,608,352,864,224,736,480,992,
  16,528,272,784,144,656,400,912,80,592,336,848,208,720,464,976,
  48,560,304,816,176,688,432,944,112,624,368,880,240,752,496,1008,
  8,520,264,776,136,648,392,904,72,584,328,840,200,712,456,968,
  40,552,296,808,168,680,424,936,104,616,360,872,232,744,488,1000,
  24,536,280,792,152,664,408,920,88,600,344,856,216,728,472,984,
  56,568,312,824,184,696,440,952,120,632,376,888,248,760,504,1016,
  4,516,260,772,132,644,388,900,68,580,324,836,196,708,452,964,
  36,548,292,804,164,676,420,932,100,612,356,868,228,740,484,996,
  20,532,276,788,148,660,404,916,84,596,340,852,212,724,468,980,
  52,564,308,820,180,692,436,948,116,628,372,884,244,756,500,1012,
  12,524,268,780,140,652,396,908,76,588,332,844,204,716,460,972,
  44,556,300,812,172,684,428,940,108,620,364,876,236,748,492,1004,
  28,540,284,796,156,668,412,924,92,604,348,860,220,732,476,988,
  60,572,316,828,188,700,444,956,124,636,380,892,252,764,508,1020
};

const uint32_t tree[256]={
  0, 128, 64, 192, 32, 160, 96, 224, 16, 144, 80, 208, 48, 176, 112, 240,
  8, 136, 72, 200, 40, 168, 104, 232, 24, 152, 88, 216, 56, 184, 120, 248,
  4, 132, 68, 196, 36, 164, 100, 228, 20, 148, 84, 212, 52, 180, 116, 244,
  12, 140, 76, 204, 44, 172, 108, 236, 28, 156, 92, 220, 60, 188, 124, 252,
  2, 130, 66, 194, 34, 162, 98, 226, 18, 146, 82, 210, 50, 178, 114, 242,
  10, 138, 74, 202, 42, 170, 106, 234, 26, 154, 90, 218, 58, 186, 122, 250,
  6, 134, 70, 198, 38, 166, 102, 230, 22, 150, 86, 214, 54, 182, 118, 246,
  14, 142, 78, 206, 46, 174, 110, 238, 30, 158, 94, 222, 62, 190, 126, 254,
  1, 129, 65, 193, 33, 161, 97, 225, 17, 145, 81, 209, 49, 177, 113, 241,
  9, 137, 73, 201, 41, 169, 105, 233, 25, 153, 89, 217, 57, 185, 121, 249,
  5, 133, 69, 197, 37, 165, 101, 229, 21, 149, 85, 213, 53, 181, 117, 245,
  13, 141, 77, 205, 45, 173, 109, 237, 29, 157, 93, 221, 61, 189, 125, 253,
  3, 131, 67, 195, 35, 163, 99, 227, 19, 147, 83, 211, 51, 179, 115, 243,
  11, 139, 75, 203, 43, 171, 107, 235, 27, 155, 91, 219, 59, 187, 123, 251,
  7, 135, 71, 199, 39, 167, 103, 231, 23, 151, 87, 215, 55, 183, 119, 247,
  15, 143, 79, 207, 47, 175, 111, 239, 31, 159, 95, 223, 63, 191, 127, 255
};

void chorder(int32_t a[N]){//Input normal order then output bit-reverse order; Input bit-reverse order then output normal order
  int32_t temp[N];
  for(int i=0;i<N;i++)temp[tree[i]]=a[i];
  copy_array(a,temp);
}

/*************************************************
* Name:        ntt
*
* Description: Forward NTT, in-place. No modular reduction is performed after
*              additions or subtractions. Output vector is in bitreversed order.
*
* Arguments:   - uint32_t p[N]: input/output coefficient array
**************************************************/
void ntt(int32_t a[N]) {
  unsigned int len, start, j, k;
  int32_t zeta, t;

  k = 0;
  for(len = 128; len > 0; len >>= 1) {
    for(start = 0; start < N; start = j + len) {
      zeta = zetas[++k];
      for(j = start; j < start + len; ++j) {
        t = montgomery_reduce((int64_t)zeta * a[j + len]);
        a[j + len] = a[j] - t;
        a[j] = a[j] + t;
      }
    }
  }
}

/*************************************************
* Name:        invntt_tomont
*
* Description: Inverse NTT and multiplication by Montgomery factor 2^32.
*              In-place. No modular reductions after additions or
*              subtractions; input coefficients need to be smaller than
*              Q in absolute value. Output coefficient are smaller than Q in
*              absolute value.
*
* Arguments:   - uint32_t p[N]: input/output coefficient array
**************************************************/
void invntt_tomont(int32_t a[N]) {
  unsigned int start, len, j, k;
  int32_t t, zeta;
  const int32_t f = 41978; // mont^2/256

  k = 256;
  for(len = 1; len < N; len <<= 1) {
    for(start = 0; start < N; start = j + len) {
      zeta = -zetas[--k];
      for(j = start; j < start + len; ++j) {
        t = a[j];
        a[j] = t + a[j + len];
        a[j + len] = t - a[j + len];
        a[j + len] = montgomery_reduce((int64_t)zeta * a[j + len]);
      }
    }
  }

  for(j = 0; j < N; ++j) {
    a[j] = montgomery_reduce((int64_t)f * a[j]);
  }
}

void copy_array(int32_t a[N], int32_t temp[N]) {
    uint32_t i;
    for (i = 0; i < N; i++) {
        a[i] = temp[i];
    }
}

/*************************************************
* Name:        invntt_CG
*
* Description: Inverse NTT.
*              Out-of-place, constant geometry.
*              Input coefficients are in standard order and normal domain.
*              Output coefficient are smaller than Q in absolute value;
*              and output coefficients are in bit-reversed order and normal domain.
*
* Arguments:   - int32_t p[N]: input/output coefficient array
**************************************************/
void invntt_CG(int32_t a[N]){
  unsigned int m, i, j;
  unsigned int r_pos, w_pos;
  unsigned int t;
  unsigned int bf_num_with_same_tw;         // 每一stage内旋转因子相同的蝶形操作个数
  int32_t zeta, t0, t1;
  int32_t temp[N] = { 0 };

  uint32_t k = 0;
  for(m=1;m<N;m*=2){
    for(i=0;i<N/(2*m);i++){
      zeta=zetas_inv_in_order[k++];
      for(j=0;j<m;j++){
        r_pos=i*m+j;
        w_pos=i*(2*m)+2*j;
        t0 = central_reduce_oneQ(a[r_pos] + a[r_pos + N / 2]);
        t1 = central_reduce_oneQ(a[r_pos] - a[r_pos + N / 2]);
        temp[w_pos] = mod_div2(t0);
        temp[w_pos + 1] = mod_div2(t1);
        temp[w_pos + 1]=montgomery_reduce((int64_t)zeta * temp[w_pos+1]);
      }
    }
    copy_array(a, temp);
  }
}