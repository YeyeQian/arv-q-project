#include "ntt.h"
#include "reduce.h"
#include "poly.h"
#include <math.h>
#include <stdio.h>
#include <stdint.h>
const int32_t zetas[SABER_N] = { //in mont domain, in bitreverse order
    0,10456819,6778549,3927384,13708128,3333183,17379375,14672026,16331523,23973142,12946161,11044490,2113559,4862186,12446784,13450938,
    19688239,14374602,10265463,4135820,11410912,19978413,23186411,5324400,15508013,4543018,18435621,11247890,20503562,10925857,18356976,9694922,
    23364730,14523207,18724034,23578947,10026366,12214809,11687629,9324823,21391632,21039891,8376768,20693015,20891462,23400914,14581325,21578259,
    2985234,15084562,21315916,228560,587030,2868469,1696077,4056008,1586642,19149710,19955077,4900932,19323068,14406467,16451040,632668,
    16688556,11508354,6175695,11420910,4344650,1919030,19731214,20677106,1902898,15871484,18973296,21351417,12038585,6669390,22387578,18129380,
    18500878,13875000,8654721,11030746,18465697,18589063,13268129,17235176,15364236,23414839,17446359,701737,22146762,22935694,10357424,7245113,
    8079648,18465049,6991324,15671273,20171942,14752388,23177262,18290700,3616172,3803606,2814992,12506386,22194035,14152981,55762,6558844,
    667111,12090048,3971895,10531211,24258592,11605612,1248015,14321926,22481166,1302629,3603005,16031872,18541967,10070719,18489938,1027635,
    1195847,4413844,17686025,20429648,9194262,5401872,1502330,3337356,143363,15131957,2524604,3458597,23927953,1617055,2430208,13446262,
    6684921,19418677,2484232,19873807,10734669,10095079,11128617,2982564,8697150,1621394,15943924,151668,18270351,18604110,4950541,8978626,
    9954956,6791101,13613697,5859458,15800433,883411,19149285,15688438,439800,8401279,21902943,16841171,24103990,2590917,20826067,23717911,
    17834047,11133158,6441259,7238671,22026666,5549675,2653886,22957916,8888852,15871991,15400860,2690208,23984142,23690486,1015493,21666575,
    10847467,17921336,23522565,4360437,7037443,16186365,6849403,5891100,19789492,20619013,20725428,15318469,11058871,17873869,3053282,1397416,
    17844256,8385038,2142558,12744765,9981572,24472442,23983096,16456862,15864935,22353801,3686319,6075986,17369762,22215596,11015242,12390938,
    11259461,6668584,8704176,7134333,8373409,13009476,2731815,15709060,13564032,15330445,6385828,2920732,2528064,18289886,13487669,22002422,
    11771991,14220771,15395272,12464090,15521617,20748932,7140031,22951637,20990206,12583083,14768256,11209398,17378310,10579778,24063766,3810156
};

const int32_t inv_zetas[SABER_N] = {//in mont domain, in bitreverse order(each stage)
    21361301,1107691,14591679,7793147,13962059,10403201,12588374,4181251,2219820,18031426,4422525,9649840,12707367,9776185,10950686,13399466,
    3169035,11683788,6881571,22643393,22250725,18785629,9841012,11607425,9462397,22439642,12161981,16798048,18037124,16467281,18502873,13911996,
    12780519,14156215,2955861,7801695,19095471,21485138,2817656,9306522,8714595,1188361,699015,15189885,12426692,23028899,16786419,7327201,
    23774041,22118175,7297588,14112586,9852988,4446029,4552444,5381965,19280357,18322054,8985092,18134014,20811020,1648892,7250121,14323990,
    3504882,24155964,1480971,1187315,22481249,9770597,9299466,16282605,2213541,22517571,19621782,3144791,17932786,18730198,14038299,7337410,
    1453546,4345390,22580540,1067467,8330286,3268514,16770178,24731657,9483019,6022172,24288046,9371024,19311999,11557760,18380356,15216501,
    16192831,20220916,6567347,6901106,25019789,9227533,23550063,16474307,22188893,14042840,15076378,14436788,5297650,22687225,5752780,18486536,
    11725195,22741249,23554402,1243504,21712860,22646853,10039500,25028094,21834101,23669127,19769585,15977195,4741809,7485432,20757613,23975610,
    24143822,6681519,15100738,6629490,9139585,21568452,23868828,2690291,10849531,23923442,13565845,912865,14640246,21199562,13081409,24504346,
    18612613,25115695,11018476,2977422,12665071,22356465,21367851,21555285,6880757,1994195,10419069,4999515,9500184,18180133,6706408,17091809,
    17926344,14814033,2235763,3024695,24469720,7725098,1756618,9807221,7936281,11903328,6582394,6705760,14140711,16516736,11296457,6670579,
    7042077,2783879,18502067,13132872,3820040,6198161,9299973,23268559,4494351,5440243,23252427,20826807,13750547,18995762,13663103,8482901,
    24538789,8720417,10764990,5848389,20270525,5216380,6021747,23584815,21115449,23475380,22302988,24584427,24942897,3855541,10086895,22186223,
    3593198,10590132,1770543,4279995,4478442,16794689,4131566,3779825,15846634,13483828,12956648,15145091,1592510,6447423,10648250,1806727,
    15476535,6814481,14245600,4667895,13923567,6735836,20628439,9663444,19847057,1985046,5193044,13760545,21035637,14905994,10796855,5483218,
    11720519,12724673,20309271,23057898,14126967,12225296,1198315,8839934,10499431,7792082,21838274,11463329,21244073,18392908,14714638,0
};

const int32_t inv_zetas_inorder[SABER_N] = {//in mont domain, in normal order(each stage)
    21361301,3504882,12780519,16192831,3169035,1453546,23774041,11725195,2219820,2213541,8714595,22188893,9462397,9483019,19280357,21834101,
    13962059,22481249,19095471,25019789,22250725,8330286,9852988,21712860,12707367,17932786,12426692,5297650,18037124,19311999,20811020,4741809,
    14591679,1480971,2955861,6567347,6881571,22580540,7297588,23554402,4422525,19621782,699015,15076378,12161981,24288046,8985092,19769585,
    12588374,9299466,2817656,23550063,9841012,16770178,4552444,10039500,10950686,14038299,16786419,5752780,18502873,18380356,7250121,20757613,
    1107691,24155964,14156215,20220916,11683788,4345390,22118175,22741249,18031426,22517571,1188361,14042840,22439642,6022172,18322054,23669127,
    10403201,9770597,21485138,9227533,18785629,3268514,4446029,22646853,9776185,18730198,23028899,22687225,16467281,11557760,1648892,7485432,
    7793147,1187315,7801695,6901106,22643393,1067467,14112586,1243504,9649840,3144791,15189885,14436788,16798048,9371024,18134014,15977195,
    4181251,16282605,9306522,16474307,11607425,24731657,5381965,25028094,13399466,7337410,7327201,18486536,13911996,15216501,14323990,23975610,
    24143822,17926344,18612613,7042077,10849531,7936281,6880757,4494351,9139585,24469720,12665071,3820040,14640246,14140711,9500184,13750547,
    15100738,2235763,11018476,18502067,13565845,6582394,10419069,23252427,23868828,1756618,21367851,9299973,13081409,11296457,6706408,13663103,
    6681519,14814033,25115695,2783879,23923442,11903328,1994195,5440243,21568452,7725098,22356465,6198161,21199562,16516736,18180133,18995762,
    6629490,3024695,2977422,13132872,912865,6705760,4999515,20826807,2690291,9807221,21555285,23268559,24504346,6670579,17091809,8482901,
    24538789,3593198,21115449,15846634,20270525,4478442,24942897,1592510,10764990,1770543,22302988,12956648,6021747,4131566,10086895,10648250,
    8720417,10590132,23475380,13483828,5216380,16794689,3855541,6447423,5848389,4279995,24584427,15145091,23584815,3779825,22186223,1806727,
    15476535,19847057,13923567,21035637,14245600,5193044,20628439,10796855,6814481,1985046,6735836,14905994,4667895,13760545,9663444,5483218,
    11720519,14126967,20309271,1198315,12724673,12225296,23057898,8839934,10499431,21838274,7792082,11463329,21244073,18392908,14714638,0
};

const uint32_t tree_byteoffset[256] = {
    0,512,256,768,128,640,384,896,64,576,320,832,192,704,448,960,
    32,544,288,800,160,672,416,928,96,608,352,864,224,736,480,992,
    16,528,272,784,144,656,400,912,80,592,336,848,208,720,464,976,
    48,560,304,816,176,688,432,944,112,624,368,880,240,752,496,1008,
    8,520,264,776,136,648,392,904,72,584,328,840,200,712,456,968,
    40,552,296,808,168,680,424,936,104,616,360,872,232,744,488,1000,
    24,536,280,792,152,664,408,920,88,600,344,856,216,728,472,984,
    56,568,312,824,184,696,440,952,120,632,376,888,248,760,504,1016,
    4,516,260,772,132,644,388,900,68,580,324,836,196,708,452,964,
    36,548,292,804,164,676,420,932,100,612,356,868,228,740,484,996,
    20,532,276,788,148,660,404,916,84,596,340,852,212,724,468,980,
    52,564,308,820,180,692,436,948,116,628,372,884,244,756,500,1012,
    12,524,268,780,140,652,396,908,76,588,332,844,204,716,460,972,
    44,556,300,812,172,684,428,940,108,620,364,876,236,748,492,1004,
    28,540,284,796,156,668,412,924,92,604,348,860,220,732,476,988,
    60,572,316,828,188,700,444,956,124,636,380,892,252,764,508,1020
};

const uint32_t tree[256] = {
    0, 128, 64, 192, 32, 160, 96, 224, 16, 144, 80, 208, 48, 176, 112, 240,
    8, 136, 72, 200, 40, 168, 104, 232, 24, 152, 88, 216, 56, 184, 120, 248,
    4, 132, 68, 196, 36, 164, 100, 228, 20, 148, 84, 212, 52, 180, 116, 244,
    12, 140, 76, 204, 44, 172, 108, 236, 28, 156, 92, 220, 60, 188, 124, 252,
    2, 130, 66, 194, 34, 162, 98, 226, 18, 146, 82, 210, 50, 178, 114, 242,
    10, 138, 74, 202, 42, 170, 106, 234, 26, 154, 90, 218, 58, 186, 122, 250,
    6, 134, 70, 198, 38, 166, 102, 230, 22, 150, 86, 214, 54, 182, 118, 246,
    14, 142, 78, 206, 46, 174, 110, 238, 30, 158, 94, 222, 62, 190, 126, 254,
    1, 129, 65, 193, 33, 161, 97, 225, 17, 145, 81, 209, 49, 177, 113, 241,
    9, 137, 73, 201, 41, 169, 105, 233, 25, 153, 89, 217, 57, 185, 121, 249,
    5, 133, 69, 197, 37, 165, 101, 229, 21, 149, 85, 213, 53, 181, 117, 245,
    13, 141, 77, 205, 45, 173, 109, 237, 29, 157, 93, 221, 61, 189, 125, 253,
    3, 131, 67, 195, 35, 163, 99, 227, 19, 147, 83, 211, 51, 179, 115, 243,
    11, 139, 75, 203, 43, 171, 107, 235, 27, 155, 91, 219, 59, 187, 123, 251,
    7, 135, 71, 199, 39, 167, 103, 231, 23, 151, 87, 215, 55, 183, 119, 247,
    15, 143, 79, 207, 47, 175, 111, 239, 31, 159, 95, 223, 63, 191, 127, 255
};

// int bitreverse(int i, int m) {
//     int j, outcome = 0;
//     for (j = 0; j < m; j++)
//     {
//         outcome = outcome + ((i >> j) & 1) * pow(2, (m - 1) - j);
//     }
//     return outcome;
// }

// void get_invzeta_normorder() {
//     unsigned int start, len, j, k;
//     int32_t t, zeta;
//     int32_t buffer[SABER_N] = { 0 };
//     unsigned int zeta_idx = 0;
//     k = 256;
//     j = 0;
//     for (len = 1; len < SABER_N; len <<= 1) {
//         for (start = 0; start < SABER_N; start = j + len) {
//             zeta = -zetas[--k];
//             buffer[zeta_idx++] = zeta < 0 ? zeta + SABER_Q_EXT : zeta;
//             for (j = start; j < start + len; ++j) {

//             }
//         }
//     }
//     printf("res:\n");
//     print_poly32(buffer);
//     int32_t buffer_res[SABER_N] = { 0 };
//     int offset = 0;
//     for (int i = 7; i >= 0; i--) {
//         int len = 1 << i;
//         for (int j = offset; j < offset + len; j++) {
//             buffer_res[offset + bitreverse(j - offset, i)] = buffer[j];
//         }
//         offset += len;
//     }
//     printf("res normal order:\n");
//     print_poly32(buffer_res);
// }

/*************************************************
* Name:        ntt
*
* Description: Forward NTT, in-place. Modular reduction is performed after
*              additions and subtractions. Output vector is in bitreversed order.
*
* Arguments:   - uint32_t p[N]: input/output coefficient array
**************************************************/
void ntt(int32_t a[SABER_N]) {
    unsigned int len, start, j, k;
    int32_t zeta, t;

    k = 0;
    for (len = 128; len > 0; len >>= 1) {
        for (start = 0; start < SABER_N; start = j + len) {
            zeta = zetas[++k];
            for (j = start; j < start + len; ++j) {
                t = montgomery_reduce(zeta ,a[j + len]);
                a[j + len] = mod_sub(a[j],t);
                a[j] = mod_add(a[j],t);
            }
        }
    }
}

/*************************************************
* Name:        invntt_tomont
*
* Description: Inverse NTT and multiplication by Montgomery factor 2^32.
*              In-place. Modular reductions after additions or
*              subtractions; input coefficients need to be smaller than
*              Q in absolute value. Output coefficient are smaller than Q in
*              absolute value.
*
* Arguments:   - uint32_t p[N]: input/output coefficient array
**************************************************/
void invntt_tomont(int32_t a[SABER_N]) {
    unsigned int start, len, j, k;
    int32_t t, zeta;
    const int32_t f = 21916245; // mont^2/256

    k = 0;
    for (len = 1; len < SABER_N; len <<= 1) {
        for (start = 0; start < SABER_N; start = j + len) {
            zeta = inv_zetas[k++];
            for (j = start; j < start + len; ++j) {
                t = a[j];
                a[j] = mod_add(t ,a[j + len]);
                a[j + len] = mod_sub(t,a[j + len]);
                a[j + len] = montgomery_reduce(zeta,a[j + len]);
            }
        }
    }

    for (j = 0; j < SABER_N; ++j) {
        a[j] = montgomery_reduce(f,a[j]);
    }
}